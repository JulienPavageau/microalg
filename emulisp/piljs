#!/usr/bin/env nodejs
fs = require('fs')

// Load EmuLisp.
var emulisp_src = fs.readFileSync('emulisp/emulisp_core.js').toString();
eval(emulisp_src);

var option_bye = false;

// Process command line args.
var arglist = process.argv.slice(2);
var script = arglist.shift();
while (typeof script != 'undefined') {
    if (script == '-bye') {
        option_bye = true;
        continue;
    }
    if(fs.existsSync(script)){
        // File interpreter.
        content = fs.readFileSync(script).toString();
        try {
            EMULISP_CORE.eval(content);
        } catch(e) {
            console.log(e.toString() + "  (piljs -> no debug yet)");
        }
    } else {
        console.log(script + " not found.");
    }
    script = arglist.shift();
}

// Start REPL if '-bye' was not passed in command line arguments.
if (!option_bye) {
    var prompt = require('sync-prompt').prompt;
    var user_input = prompt(': ');
    while (user_input != '(bye)') {
        try {
            var result = EMULISP_CORE.eval(user_input);
            console.log('-> ' + result);
        } catch(e) {
            console.log(e.toString() + "  (piljs -> no debug yet)");
        }
        user_input = prompt(': ');
    }
}
